<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tirage au sort des cadeaux</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wrapper {
      width: 100%;
      padding: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      width: 100%;
      max-width: 1100px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 1.5rem;
      padding: 1.75rem 1.5rem;
      box-shadow:
        0 25px 70px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(18px);
    }

    h1 {
      margin: 0 0 0.4rem;
      text-align: center;
      font-size: 1.9rem;
      letter-spacing: 0.03em;
    }

    .subtitle {
      text-align: center;
      font-size: 0.95rem;
      color: #9ca3af;
      margin-bottom: 1.4rem;
    }

    .section-title {
      font-weight: 600;
      font-size: 1.05rem;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .section-title span {
      font-size: 1.2rem;
    }

    .hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.45rem 0.4rem;
      border-bottom: 1px solid #111827;
      vertical-align: middle;
    }

    th {
      text-align: left;
      background: rgba(15, 23, 42, 0.95);
      font-weight: 600;
      color: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.75);
    }

    tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.6);
    }

    .table-container {
      max-height: 320px;
      overflow: auto;
      border-radius: 0.9rem;
      border: 1px solid #1f2937;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      margin-bottom: 0.75rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.55rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    button {
      border: none;
      border-radius: 9999px;
      padding: 0.6rem 1.3rem;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #0b1120;
      box-shadow: 0 12px 30px rgba(59, 130, 246, 0.55);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0ea5e9, #4f46e5);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .btn-secondary:hover {
      background: rgba(31, 41, 55, 0.98);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
    }

    .btn-danger {
      background: rgba(127, 29, 29, 0.85);
      color: #fee2e2;
      border: 1px solid rgba(248, 113, 113, 0.7);
      padding: 0.3rem 0.7rem;
      font-size: 0.75rem;
    }

    .btn-danger:hover {
      background: rgba(185, 28, 28, 0.95);
    }

    .actions {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .status {
      font-size: 0.85rem;
      color: #9ca3af;
      min-height: 1.1rem;
    }

    .status.error { color: #fb7185; }
    .status.success { color: #4ade80; }

    .two-columns {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .copy-area-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 0.55rem;
      font-size: 0.85rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      resize: vertical;
    }

    .notifications-table td {
      font-size: 0.85rem;
    }

    .badge-contact {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }

    .badge-contact.mail {
      border-color: #38bdf8;
      color: #bae6fd;
    }

    .badge-contact.sms {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    a.btn-link {
      text-decoration: none;
    }

    .hidden { display: none !important; }

    @media (max-width: 900px) {
      .card { padding: 1.3rem 1.1rem; border-radius: 1.2rem; }
      h1 { font-size: 1.6rem; }
      .two-columns { grid-template-columns: 1fr; }
      .table-container { max-height: 260px; }
      button { width: 100%; justify-content: center; }
      .actions { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="card">
      <h1>Tirage au sort des cadeaux</h1>
      <p class="subtitle">
        Tu saisis chaque personne : contacts, couple, et <strong>cadeau id√©al</strong>.  
        Le tirage respecte les couples, et celui qui offre re√ßoit la personne + l‚Äôid√©e de cadeau.
      </p>

      <div>
        <div class="section-title">
          <span>üéØ</span> Participants
        </div>
        <p class="hint">
          Une ligne par personne. Au moins un moyen de contact (email ou t√©l√©phone).  
          Pour la contrainte de couple, indique le <strong>nom complet</strong> de l‚Äôautre.
        </p>

        <div style="margin-bottom:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
          <button id="add-participant" class="btn-secondary">+ Ajouter un participant</button>
          <button id="add-example" class="btn-secondary">Pr√©-remplir avec un exemple</button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Pr√©nom</th>
                <th>Nom</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
                <th>En couple avec</th>
                <th>Cadeau id√©al</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="participants-body">
              <!-- lignes g√©n√©r√©es en JS -->
            </tbody>
          </table>
        </div>

        <div class="hint">
          ‚ûú Pour les couples, mets exactement le m√™me nom complet que dans la ligne de l‚Äôautre  
          (ex : ¬´ Alice Dupont ¬ª ‚Üî ¬´ Bob Martin ¬ª).  
          ‚ûú Le champ <strong>Cadeau id√©al</strong> peut rester vide si la personne ne sait pas.
        </div>

        <div class="actions">
          <button id="btn-generate" class="btn-primary">üéÅ G√©n√©rer le tirage</button>
          <button id="btn-clear" class="btn-secondary">üßπ Vider tout</button>
          <span id="status" class="status"></span>
        </div>
      </div>

      <div id="results-section" class="hidden" style="margin-top:1.4rem;">
        <div class="section-title">
          <span>üìú</span> R√©sultat du tirage (pour l‚Äôorganisateur)</div>
        <div id="results-meta" class="hint"></div>

        <div class="table-container" style="max-height:260px; margin-top:0.5rem;">
          <table>
            <thead>
              <tr>
                <th>Offre</th>
                <th>√Ä</th>
                <th>Souhait du receveur</th>
              </tr>
            </thead>
            <tbody id="results-table-body"></tbody>
          </table>
        </div>

        <div class="two-columns">
          <div>
            <div class="copy-area-title">R√©sum√© texte du tirage</div>
            <div class="hint">Pratique pour archiver ou garder une copie.</div>
            <textarea id="copy-pairs" readonly></textarea>
          </div>
          <div>
            <div class="copy-area-title">Messages √† envoyer (backup)</div>
            <div class="hint">
              Tous les messages (mail/SMS) bruts. L‚Äôenvoi r√©el se fait via les boutons ci-dessous pour chaque personne.
            </div>
            <textarea id="copy-messages" readonly></textarea>
          </div>
        </div>

        <div style="margin-top:1.4rem;">
          <div class="section-title">
            <span>üì®</span> Pr√©parer les mails et SMS
          </div>
          <p class="hint">
            Un bloc par personne. Sur t√©l√©phone : les SMS s‚Äôouvrent dans l‚Äôappli Messages.  
            Tu n‚Äôas plus qu‚Äô√† v√©rifier le texte (avec le cadeau id√©al) et envoyer.
          </p>

          <div class="table-container" style="max-height:260px;">
            <table class="notifications-table">
              <thead>
                <tr>
                  <th>Participant</th>
                  <th>Contacts</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="notifications-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const participantsBody = document.getElementById('participants-body');
    const addParticipantBtn = document.getElementById('add-participant');
    const addExampleBtn = document.getElementById('add-example');
    const btnGenerate = document.getElementById('btn-generate');
    const btnClear = document.getElementById('btn-clear');
    const statusEl = document.getElementById('status');
    const resultsSection = document.getElementById('results-section');
    const resultsMeta = document.getElementById('results-meta');
    const resultsTableBody = document.getElementById('results-table-body');
    const copyPairsArea = document.getElementById('copy-pairs');
    const copyMessagesArea = document.getElementById('copy-messages');
    const notificationsBody = document.getElementById('notifications-body');

    function setStatus(msg, type = '') {
      statusEl.textContent = msg || '';
      statusEl.className = 'status';
      if (type === 'error') statusEl.classList.add('error');
      if (type === 'success') statusEl.classList.add('success');
    }

    function createParticipantRow(data = {}) {
      const tr = document.createElement('tr');
      tr.className = 'participant-row';

      const tdFirst = document.createElement('td');
      const tdLast = document.createElement('td');
      const tdEmail = document.createElement('td');
      const tdPhone = document.createElement('td');
      const tdPartner = document.createElement('td');
      const tdGift = document.createElement('td');
      const tdRemove = document.createElement('td');

      const inputFirst = document.createElement('input');
      inputFirst.type = 'text';
      inputFirst.placeholder = 'Pr√©nom';
      inputFirst.value = data.firstName || '';

      const inputLast = document.createElement('input');
      inputLast.type = 'text';
      inputLast.placeholder = 'Nom';
      inputLast.value = data.lastName || '';

      const inputEmail = document.createElement('input');
      inputEmail.type = 'email';
      inputEmail.placeholder = 'email@example.com';
      inputEmail.value = data.email || '';

      const inputPhone = document.createElement('input');
      inputPhone.type = 'tel';
      inputPhone.placeholder = '06XXXXXXXX';
      inputPhone.value = data.phone || '';

      const inputPartner = document.createElement('input');
      inputPartner.type = 'text';
      inputPartner.placeholder = 'Nom Pr√©nom du conjoint';
      inputPartner.value = data.partner || '';

      const inputGift = document.createElement('input');
      inputGift.type = 'text';
      inputGift.placeholder = 'Ex. parfum, livre, Lego...';
      inputGift.value = data.gift || '';

      const btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.className = 'btn-danger';
      btnDel.textContent = 'Supprimer';
      btnDel.addEventListener('click', () => {
        tr.remove();
      });

      tdFirst.appendChild(inputFirst);
      tdLast.appendChild(inputLast);
      tdEmail.appendChild(inputEmail);
      tdPhone.appendChild(inputPhone);
      tdPartner.appendChild(inputPartner);
      tdGift.appendChild(inputGift);
      tdRemove.appendChild(btnDel);

      tr.appendChild(tdFirst);
      tr.appendChild(tdLast);
      tr.appendChild(tdEmail);
      tr.appendChild(tdPhone);
      tr.appendChild(tdPartner);
      tr.appendChild(tdGift);
      tr.appendChild(tdRemove);

      participantsBody.appendChild(tr);
    }

    function clearParticipants() {
      participantsBody.innerHTML = '';
    }

    addParticipantBtn.addEventListener('click', () => {
      createParticipantRow();
    });

    addExampleBtn.addEventListener('click', () => {
      clearParticipants();
      const exemples = [
        { firstName: 'Alice', lastName: 'Dupont', email: 'alice@test.com', phone: '', partner: 'Bob Martin', gift: 'Livre de d√©veloppement perso' },
        { firstName: 'Bob', lastName: 'Martin', email: '', phone: '0601020304', partner: 'Alice Dupont', gift: 'Montre connect√©e' },
        { firstName: 'Carole', lastName: 'Durand', email: 'carole@test.com', phone: '', partner: 'David Leroy', gift: 'Parfum' },
        { firstName: 'David', lastName: 'Leroy', email: '', phone: '0611223344', partner: 'Carole Durand', gift: 'Bouteille de vin' },
        { firstName: 'Emma', lastName: 'Morel', email: 'emma@test.com', phone: '', partner: '', gift: 'Bougie parfum√©e' },
        { firstName: 'Lucas', lastName: 'Bernard', email: '', phone: '0655667788', partner: '', gift: 'Casque audio' }
      ];
      exemples.forEach(e => createParticipantRow(e));
    });

    btnClear.addEventListener('click', () => {
      clearParticipants();
      resultsSection.classList.add('hidden');
      copyPairsArea.value = '';
      copyMessagesArea.value = '';
      notificationsBody.innerHTML = '';
      setStatus('Liste vid√©e.');
    });

    function normalizeFullName(first, last) {
      return (first + ' ' + last).trim().toLowerCase();
    }

    function parseParticipants() {
      const rows = Array.from(document.querySelectorAll('.participant-row'));
      const participants = [];

      for (const row of rows) {
        const inputs = row.querySelectorAll('input');
        const firstName = inputs[0].value.trim();
        const lastName = inputs[1].value.trim();
        const email = inputs[2].value.trim();
        const phone = inputs[3].value.trim();
        const partner = inputs[4].value.trim();
        const gift = inputs[5].value.trim();

        if (!firstName && !lastName && !email && !phone && !partner && !gift) {
          continue; // ligne totalement vide
        }

        if (!firstName || !lastName) {
          throw new Error('Chaque participant doit avoir un pr√©nom et un nom.');
        }

        if (!email && !phone) {
          throw new Error(`Il faut un email ou un t√©l√©phone pour ${firstName} ${lastName}.`);
        }

        participants.push({
          id: participants.length,
          firstName,
          lastName,
          email,
          phone,
          partnerName: partner,
          giftWish: gift
        });
      }

      if (participants.length < 2) {
        throw new Error('Il faut au moins 2 participants.');
      }

      return participants;
    }

    function generateDraw(participants, maxTries = 8000) {
      const n = participants.length;
      const nameIndex = new Map();

      participants.forEach(p => {
        nameIndex.set(normalizeFullName(p.firstName, p.lastName), p.id);
      });

      const forbidden = new Map();

      participants.forEach(p => {
        const set = new Set();
        set.add(p.id); // pas soi-m√™me

        if (p.partnerName) {
          const partnerId = nameIndex.get(p.partnerName.trim().toLowerCase());
          if (partnerId !== undefined) {
            set.add(partnerId);
          }
        }

        forbidden.set(p.id, set);
      });

      const ids = participants.map(p => p.id);

      for (let attempt = 0; attempt < maxTries; attempt++) {
        const receivers = [...ids];
        // m√©lange
        for (let i = receivers.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [receivers[i], receivers[j]] = [receivers[j], receivers[i]];
        }

        let ok = true;
        for (let i = 0; i < n; i++) {
          const giverId = ids[i];
          const receiverId = receivers[i];
          const forb = forbidden.get(giverId);
          if (forb && forb.has(receiverId)) {
            ok = false;
            break;
          }
        }

        if (ok) {
          const assignments = [];
          for (let i = 0; i < n; i++) {
            assignments.push({ giverId: ids[i], receiverId: receivers[i] });
          }
          return assignments;
        }
      }

      throw new Error("Impossible de g√©n√©rer un tirage qui respecte toutes les contraintes (couples, etc.). V√©rifie les noms ¬´ En couple avec ¬ª.");
    }

    function buildMessages(participants, assignments) {
      const byId = new Map();
      participants.forEach(p => byId.set(p.id, p));

      const linesPairs = [];
      const messageBlocks = [];
      const notificationsRows = [];

      assignments.forEach(a => {
        const giver = byId.get(a.giverId);
        const receiver = byId.get(a.receiverId);
        if (!giver || !receiver) return;

        const giverFull = `${giver.firstName} ${giver.lastName}`;
        const receiverFull = `${receiver.firstName} ${receiver.lastName}`;
        const wish = (receiver.giftWish || '').trim();

        const wishLine = wish
          ? `Id√©e cadeau : ${wish}.`
          : `(Cette personne n'a pas indiqu√© de cadeau id√©al pr√©cis, fais-toi plaisir üòâ.)`;

        linesPairs.push(`${giverFull} -> ${receiverFull} ${wish ? `(souhait: ${wish})` : ''}`);

        const msg =
`Bonjour ${giver.firstName},

Tu offriras un cadeau √† : ${receiverFull}.
${wishLine}

Garde cette info pour toi üòä
(Ne r√©ponds pas √† tout le monde, sinon tu spoiles le tirage !)`;

        messageBlocks.push(
`Pour : ${giverFull}
Email : ${giver.email || '-'}
T√©l√©phone : ${giver.phone || '-'}
Message :
${msg}
`
        );

        notificationsRows.push({ giver, receiverFull, message: msg });
      });

      return { linesPairs, messageBlocks, notificationsRows };
    }

    function renderResults(participants, assignments) {
      resultsTableBody.innerHTML = '';
      notificationsBody.innerHTML = '';

      const { linesPairs, messageBlocks, notificationsRows } = buildMessages(participants, assignments);

      assignments.forEach(a => {
        const giver = participants.find(p => p.id === a.giverId);
        const receiver = participants.find(p => p.id === a.receiverId);
        if (!giver || !receiver) return;

        const tr = document.createElement('tr');
        const tdG = document.createElement('td');
        const tdR = document.createElement('td');
        const tdW = document.createElement('td');

        tdG.textContent = `${giver.firstName} ${giver.lastName}`;
        tdR.textContent = `${receiver.firstName} ${receiver.lastName}`;
        tdW.textContent = receiver.giftWish ? receiver.giftWish : '‚Äî';

        tr.appendChild(tdG);
        tr.appendChild(tdR);
        tr.appendChild(tdW);
        resultsTableBody.appendChild(tr);
      });

      copyPairsArea.value = linesPairs.join('\n');
      copyMessagesArea.value = messageBlocks.join('\n------------------------------\n\n');

      notificationsRows.forEach(item => {
        const { giver, message } = item;

        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        const tdContacts = document.createElement('td');
        const tdActions = document.createElement('td');

        tdName.textContent = `${giver.firstName} ${giver.lastName}`;

        const contactBadges = [];
        if (giver.email) {
          const span = document.createElement('span');
          span.className = 'badge-contact mail';
          span.textContent = giver.email;
          contactBadges.push(span);
        }
        if (giver.phone) {
          const span = document.createElement('span');
          span.className = 'badge-contact sms';
          span.textContent = giver.phone;
          contactBadges.push(span);
        }
        if (contactBadges.length === 0) {
          tdContacts.textContent = 'Aucun contact';
        } else {
          contactBadges.forEach((b, idx) => {
            if (idx > 0) tdContacts.appendChild(document.createTextNode(' '));
            tdContacts.appendChild(b);
          });
        }

        const actions = [];

        if (giver.email) {
          const subject = 'Tirage de No√´l - ta personne √† g√¢ter';
          const href = `mailto:${encodeURIComponent(giver.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
          const aMail = document.createElement('a');
          aMail.href = href;
          aMail.className = 'btn-link';
          const btnMail = document.createElement('button');
          btnMail.className = 'btn-secondary';
          btnMail.textContent = 'Pr√©parer le mail';
          aMail.appendChild(btnMail);
          actions.push(aMail);
        }

        if (giver.phone) {
          const hrefSms = `sms:${encodeURIComponent(giver.phone)}?&body=${encodeURIComponent(message)}`;
          const aSms = document.createElement('a');
          aSms.href = hrefSms;
          aSms.className = 'btn-link';
          const btnSms = document.createElement('button');
          btnSms.className = 'btn-secondary';
          btnSms.textContent = 'Pr√©parer le SMS';
          aSms.appendChild(btnSms);
          actions.push(aSms);
        }

        if (actions.length === 0) {
          tdActions.textContent = 'Compl√©ter email / t√©l√©phone';
        } else {
          actions.forEach((el, idx) => {
            if (idx > 0) tdActions.appendChild(document.createTextNode(' '));
            tdActions.appendChild(el);
          });
        }

        tr.appendChild(tdName);
        tr.appendChild(tdContacts);
        tr.appendChild(tdActions);
        notificationsBody.appendChild(tr);
      });

      resultsMeta.textContent =
        `${participants.length} participants ‚Ä¢ tirage g√©n√©r√© le ${new Date().toLocaleString('fr-FR')}`;
      resultsSection.classList.remove('hidden');
    }

    btnGenerate.addEventListener('click', () => {
      try {
        setStatus('');
        const participants = parseParticipants();
        const assignments = generateDraw(participants);
        renderResults(participants, assignments);
        setStatus('Tirage effectu√© avec succ√®s.', 'success');
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'Erreur pendant le tirage.', 'error');
        resultsSection.classList.add('hidden');
      }
    });

    // On commence avec quelques lignes vides pour aider
    for (let i = 0; i < 4; i++) {
      createParticipantRow();
    }
    
  </script>
</body>
</html>
